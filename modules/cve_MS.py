import contextlib
from modules.info_push import post_message_to_WXWork
from modules.cmdb import add_cve_MS_info
import requests


def getMSDATA():
    print("微软漏洞信息监控中")
    ms_url = "https://api.msrc.microsoft.com/sug/v2.0/zh-CN/vulnerability"
    header = {
        "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.80 Safari/537.36",
        "cache-control": "no-store",
        "content-encoding": "gzip",
        "content-language": "zh-CN",
        "content-type": "application/json; odata.metadata=minimal; odata.streaming=true; charset=utf-8",
        "Connection": "keep-alive",
    }
    json_str = requests.get(ms_url, headers=header, timeout=30).json()
    # 目标的键，共有五个
    target_values = ["cveTitle", "cveNumber", "releaseDate", "tag", "mitreUrl"]
    for cve_num in range(200):
        # 目前取到的键的值，顺序与target_values一致
        existed_values = ["空"] * 5
        for i in range(5):
            with contextlib.suppress(Exception):
                existed_values[i] = json_str["value"][cve_num][target_values[i]]
        if result := add_cve_MS_info(
            existed_values[0],
            existed_values[1],
            existed_values[2],
            existed_values[3],
            existed_values[4],
        ):
            markdown = f"微软新增漏洞，名称{existed_values[0]}，编号{existed_values[1]}\r\n[相关链接]({existed_values[4]})"
            post_message_to_WXWork(markdown)
        else:
            break
    print("微软漏洞信息更新完成")
